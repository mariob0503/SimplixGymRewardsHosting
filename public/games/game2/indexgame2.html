<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simplix Gym Rewards - Image Sequence Game</title>
    <style>
        /* Existing styles remain unchanged */
        body {
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }
        header {
            text-align: center;
            width: 100%;
            max-width: 800px;
            box-sizing: border-box;
            box-shadow: 0 0 5px #FFFFFF, 0 0 10px #FFFFFF, 0 0 15px #FFFFFF;
            padding: 1.5rem 1rem;
            margin-top: 0.5rem;
        }
        header h1 {
            font-size: 2rem;
            margin: 0;
        }
        header h1 span {
            color: #00BFFF;
        }
        header h3 {
            font-size: 1.3rem;
            margin: 0.125rem 0 0 0;
        }
        #game {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #111;
            border-radius: 10px;
            box-shadow: 0 0 10px #00BFFF, 0 0 20px #00BFFF;
            position: relative;
            margin: 2rem 0;
            max-width: 90%;
            width: 100%;
        }
        #topImages {
            display: flex;
            justify-content: center;
            flex-wrap: nowrap;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }
        #topImages img {
            flex: 0 0 auto;
            width: calc(33.33% - 10px);
            max-width: 100px;
            height: auto;
            aspect-ratio: 1/1;
            margin: 5px;
            border: 2px solid #333;
            border-radius: 5px;
            object-fit: contain;
        }
        #bottomImages {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }
        #bottomImages img {
            width: 80px;
            height: 80px;
            margin: 5px;
            cursor: pointer;
            border: 2px solid #333;
            border-radius: 5px;
            transition: transform 0.2s, border-color 0.2s;
        }
        #bottomImages img:hover {
            transform: scale(1.1);
            border-color: #00BFFF;
        }
        #bottomImages img.selected {
            border-color: #00BFFF;
            box-shadow: 0 0 5px #00BFFF, 0 0 10px #00BFFF;
        }
        #timer {
            font-size: 24px;
            margin-top: 15px;
            color: #00BFFF;
            font-weight: bold;
        }
        #score {
            font-size: 22px;
            margin-top: 10px;
            color: #00BFFF;
        }
        #leaderboard {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2vw;
            box-sizing: border-box;
            transition: opacity 0.5s ease-out;
        }
        #leaderboard h2 {
            color: #00BFFF;
            font-size: min(6vw, 4rem);
            margin-bottom: 2vh;
            text-shadow: 0 0 10px #00BFFF;
        }
        #scoreList {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
        }
        #scoreList li {
            font-size: min(3vw, 2rem);
            padding: 2vh;
            margin: 1vh 0;
            border-radius: 10px;
            text-align: center;
        }
        #scoreList li:nth-child(1) {
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1));
            color: #FFD700;
            border: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
            font-weight: bold;
        }
        #scoreList li:nth-child(2) {
            background: linear-gradient(45deg, rgba(192, 192, 192, 0.2), rgba(192, 192, 192, 0.1));
            color: #C0C0C0;
            border: 2px solid rgba(192, 192, 192, 0.3);
            box-shadow: 0 0 15px rgba(192, 192, 192, 0.2);
            font-weight: bold;
        }
        #scoreList li:nth-child(3) {
            background: linear-gradient(45deg, rgba(205, 127, 50, 0.2), rgba(205, 127, 50, 0.1));
            color: #CD7F32;
            border: 2px solid rgba(205, 127, 50, 0.3);
            box-shadow: 0 0 15px rgba(205, 127, 50, 0.2);
            font-weight: bold;
        }
        #scoreList li:nth-child(n+4) {
            background: rgba(0, 191, 255, 0.1);
            color: #E0E0E0;
            border: 2px solid rgba(0, 191, 255, 0.2);
            box-shadow: 0 0 10px rgba(0, 191, 255, 0.1);
        }
        button {
            background-color: #00BFFF;
            color: #fff;
            border: none;
            padding: 15px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 0 5px #00BFFF, 0 0 10px #00BFFF;
        }
        button:hover {
            background-color: #009acd;
            transform: scale(1.05);
        }
        button:active {
            transform: scale(0.98);
        }
        .glow-effect {
            filter: brightness(150%) blur(2px);
            opacity: 0.5;
        }
        #rocket {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            transition: bottom 2s ease-out;
        }
        .firework {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: explode 1s ease-out forwards;
        }
        @keyframes explode {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }
        /* Sound toggle button styles - 26.02.2025 start */
        #soundToggle {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border: 2px solid #00BFFF;
            z-index: 10;
        }
        #soundToggle img {
            width: 24px;
            height: 24px;
        }
        /* 26.02.2025 end */
        /* 4K and large screen optimization */
        @media (min-width: 2560px) {
            #leaderboard {
                padding: 4vh;
            }
            
            #scoreList {
                max-width: 2000px;
            }
            
            #leaderboard h2 {
                font-size: min(5vw, 6rem);
            }
            
            #scoreList li {
                font-size: min(2.5vw, 3rem);
                padding: 3vh;
                margin: 2vh 0;
            }
        }
        /* Updated leaderboard styles for mobile view */
        .leaderboard-container {
            width: 100%;
            max-width: 600px;
            overflow: hidden;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.75);
            margin-bottom: 20px;
            padding: 15px;
        }

        .leaderboard-header {
            display: grid;
            grid-template-columns: 60px 1fr 80px 80px 80px;
            gap: 8px;
            background-color: rgba(0, 191, 255, 0.2);
            padding: 12px 8px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            color: #00BFFF;
            margin-bottom: 8px;
        }

        .leaderboard-header > div {
            text-align: center;
        }

        .leaderboard-header > div:nth-child(2) {
            text-align: left;
            padding-left: min(2vw, 15px);
        }

        .leaderboard-list {
            max-height: 60vh;
            overflow-y: auto;
        }

        .leaderboard-entry {
            display: grid;
            grid-template-columns: 60px 1fr 80px 80px 80px;
            gap: 8px;
            padding: 12px 8px;
            margin-bottom: 8px;
            border-radius: 8px;
            align-items: center;
            animation: slideIn 0.3s ease-out forwards;
        }

        /* Base styles for all ranks */
        .rank-1, .rank-2, .rank-3, .rank-other {
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        /* Gold rank */
        .rank-1 {
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1));
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .rank-1 .rank-badge {
            background-color: #FFD700;
            color: #000;
        }

        .rank-1 .name-column {
            color: #FFD700;
        }

        /* Silver rank */
        .rank-2 {
            background: linear-gradient(45deg, rgba(192, 192, 192, 0.2), rgba(192, 192, 192, 0.1));
            border: 2px solid rgba(192, 192, 192, 0.3);
        }

        .rank-2 .rank-badge {
            background-color: #C0C0C0;
            color: #000;
        }

        .rank-2 .name-column {
            color: #C0C0C0;
        }

        /* Bronze rank */
        .rank-3 {
            background: linear-gradient(45deg, rgba(205, 127, 50, 0.2), rgba(205, 127, 50, 0.1));
            border: 2px solid rgba(205, 127, 50, 0.3);
        }

        .rank-3 .rank-badge {
            background-color: #CD7F32;
            color: #000;
        }

        .rank-3 .name-column {
            color: #CD7F32;
        }

        /* Other ranks */
        .rank-other {
            background: rgba(0, 191, 255, 0.1);
            border: 1px solid rgba(0, 191, 255, 0.2);
        }

        .rank-badge {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-weight: bold;
            font-size: 16px;
            background-color: rgba(0, 191, 255, 0.2);
            color: #fff;
        }

        .trophy-icon {
            margin-left: 4px;
            font-size: 16px;
        }

        /* Mobile optimizations */
        @media (max-width: 480px) {
            .leaderboard-entry {
                grid-template-columns: 50px 1fr 60px 60px 60px;
                gap: 4px;
                padding: 8px 4px;
                font-size: 12px;
            }

            .rank-badge {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }

            .trophy-icon {
                font-size: 14px;
            }

            .name-column {
                padding-left: 4px !important;
            }
        }

        .loading-message {
            text-align: center;
            padding: 20px;
            color: #00BFFF;
            font-size: 18px;
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Media queries for responsive leaderboard */
        @media (max-width: 768px) {
            .leaderboard-container {
                max-width: 95%;
                padding: min(2vh, 1rem);
            }
            
            .leaderboard-header, .leaderboard-entry {
                grid-template-columns: minmax(50px, 60px) minmax(120px, 1fr) minmax(60px, 80px) minmax(60px, 80px) minmax(60px, 80px);
                gap: 0.5rem;
                font-size: 14px;
            }
            
            #leaderboard h2 {
                font-size: 28px;
            }
            
            .rank-badge {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }
            
            #playAgain {
                width: 80%;
                padding: 15px;
                font-size: 18px;
            }
        }

        /* For large screens */
        @media (min-width: 1200px) {
            .leaderboard-container {
                max-width: 800px;
            }
        }

        /* For 4K screens */
        @media (min-width: 2560px) {
            .leaderboard-container {
                max-width: 1200px;
            }
        }
        #statusBar {
            width: 100%;
            background-color: #111;
            color: #00BFFF;
            text-align: center;
            padding: 10px 0;
            font-size: 1.2rem;
            box-shadow: 0 0 5px #00BFFF, 0 0 10px #00BFFF;
        }
        .animated-entry {
            animation: slideIn 0.3s ease-out forwards;
        }
        /* Add styles for nutrition prompt */
        #nutritionPrompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2vw;
            box-sizing: border-box;
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }

        #nutritionPrompt img {
            max-width: 80%;
            height: auto;
            margin-bottom: 2vh;
            object-fit: contain;
        }

        #nutritionPrompt h2 {
            color: #00BFFF;
            font-size: min(6vw, 4rem);
            margin: 2vh 0;
            text-shadow: 0 0 10px #00BFFF;
            text-align: center;
        }

        #nutritionButton {
            background: linear-gradient(45deg, #00BFFF, #0077BE);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: min(4vw, 1.5rem);
            border-radius: 50px;
            cursor: pointer;
            margin-top: 30px;
            box-shadow: 0 0 20px rgba(0, 191, 255, 0.3);
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }

        #nutritionButton:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 191, 255, 0.5);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @media (max-width: 768px) {
            #nutritionPrompt h2 {
                font-size: min(8vw, 2rem);
                padding: 0 20px;
            }
            
            #nutritionButton {
                padding: 15px 30px;
                font-size: min(5vw, 1.2rem);
            }
        }
    </style>
    <script src="/js/particleAnimation.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
</head>
<body>
    <header>
        <h1>Lift and <span>Earn</span></h1>
        <h3>Simplix Gym Rewards</h3>
    </header>
    <div id="statusBar">Round: 1 | Total Points: 0</div>
    <div id="game">
        <!-- Sound toggle button - 26.02.2025 start -->
        <div id="soundToggle">
            <img src="assets/images/sound-on.png" alt="Sound Toggle" id="soundIcon">
        </div>
        <!-- 26.02.2025 end -->
        <div id="topImages">
            <img id="top1" alt="Top Image 1">
            <img id="top2" alt="Top Image 2">
            <img id="top3" alt="Top Image 3">
        </div>
        <div id="bottomImages"></div>
        <div id="timer">Time: 30.0s</div>
        <div id="score">Score: 0 (Round: 1)</div>
    </div>
    
    <div id="leaderboard" style="display: none;">
        <h2>Leaderboard</h2>
        <div class="leaderboard-container">
            <div class="leaderboard-header">
                <div>Rank</div>
                <div>Player</div>
                <div>Rounds</div>
                <div>Points</div>
                <div>Tier</div>
            </div>
            <div id="scoreList" class="leaderboard-list">
                <div class="loading-message">Loading leaderboard data...</div>
            </div>
        </div>
        <button id="playAgain" style="margin-top: 20px;">Play Again</button>
    </div>
    
    <!-- Firebase Debug Box -->
    <div id="firebaseDebugBox" style="display: none; position: fixed; bottom: 10px; left: 10px; right: 10px; max-height: 200px; background-color: rgba(0,0,0,0.8); border: 2px solid #00BFFF; color: #fff; padding: 10px; overflow-y: auto; z-index: 1000; font-family: monospace; font-size: 12px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <strong>Firebase Debug Messages</strong>
            <button id="closeDebugBox" style="background: none; border: none; color: #00BFFF; cursor: pointer;">Close</button>
        </div>
        <div id="firebaseDebugMessages"></div>
    </div>

    <img id="rocket" src="assets/images/rocket.png" style="display: none;">

    <canvas id="particleCanvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;"></canvas>

    <div id="nutritionPrompt" style="display: none;">
        <img src="/leaderboard/logoshop.png" alt="Simplix Shop Logo">
        <h2>Ready for Nutrition Discounts?</h2>
        <button id="nutritionButton" onclick="window.open('https://simplixnutrition.de', '_blank')">
            Click Here!
        </button>
    </div>

    <script>
        // Initialize Firebase early to ensure auth persistence
        const firebaseConfig = {
            apiKey: "AIzaSyClBe85KzYpdCBmidhGlJlw-1eUZG9aBg8",
            authDomain: "simplixgymrewards.firebaseapp.com",
            databaseURL: "https://simplixgymrewards-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "simplixgymrewards",
            storageBucket: "simplixgymrewards.appspot.com",
            messagingSenderId: "821049711023",
            appId: "1:821049711023:web:32fb1e80755cc00531f75a"
        };
        
        // Only initialize if not already initialized
        if (!window.firebase || !firebase.apps || !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            
            // Set persistence to LOCAL to maintain auth state across page loads
            firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .catch(error => {
                    console.error("Error setting auth persistence:", error);
                });
        }
        
        // Check if debug mode is enabled via URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const debugEnabled = urlParams.has('debug');
        
        // Function to check and restore auth state
        function checkAndRestoreAuth() {
            return new Promise((resolve, reject) => {
                // First check if we're already authenticated
                const currentUser = firebase.auth().currentUser;
                if (currentUser) {
                    logFirebaseDebug(`User already authenticated: ${currentUser.uid}`);
                    return resolve(currentUser);
                }

                // Get userId from URL
                const urlParams = new URLSearchParams(window.location.search);
                const userId = urlParams.get('userId');
                const authToken = urlParams.get('authToken');

                if (userId) {
                    logFirebaseDebug(`Found user ID in URL: ${userId}`);
                    
                    if (authToken) {
                        // Try to sign in with custom token
                        firebase.auth().signInWithCustomToken(authToken)
                            .then((userCredential) => {
                                logFirebaseDebug(`Successfully signed in with token`);
                                resolve(userCredential.user);
                            })
                            .catch((error) => {
                                logFirebaseDebug(`Token sign-in failed, using userId as fallback: ${error.message}`);
                                // Fallback to using userId directly
                                const customUser = { uid: userId, isCustomAuth: true };
                                // Store in session for persistence
                                sessionStorage.setItem('gameUserId', userId);
                                resolve(customUser);
                            });
                    } else {
                        // No token, use userId directly
                        logFirebaseDebug(`No auth token, using userId directly`);
                        const customUser = { uid: userId, isCustomAuth: true };
                        // Store in session for persistence
                        sessionStorage.setItem('gameUserId', userId);
                        resolve(customUser);
                    }
                } else {
                    logFirebaseDebug(`No authenticated user found and no userId in URL`, true);
                    reject(new Error("No authenticated user found"));
                }
            });
        }

        // Call the function to check and restore auth state
        checkAndRestoreAuth()
            .then(user => {
                logFirebaseDebug(`Authentication check completed successfully, user: ${user.uid}`);
                // Store the user ID in session storage as backup
                sessionStorage.setItem('gameUserId', user.uid);
            })
            .catch(error => {
                logFirebaseDebug(`Authentication check failed: ${error.message}`, true);
            });
        
        // Firebase debug logging function
        function logFirebaseDebug(message, isError = false) {
            // Always log to console regardless of debug mode
            if (isError) {
                console.error(message);
            } else {
                console.log(message);
            }
            
            // Only show in UI if debug mode is enabled
            if (!debugEnabled) return;
            
            const debugBox = document.getElementById('firebaseDebugBox');
            const debugMessages = document.getElementById('firebaseDebugMessages');
            
            // Create timestamp
            const now = new Date();
            const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}.${now.getMilliseconds().toString().padStart(3, '0')}`;
            
            // Create message element
            const messageElement = document.createElement('div');
            messageElement.style.marginBottom = '5px';
            messageElement.style.color = isError ? '#ff6b6b' : '#fff';
            messageElement.innerHTML = `<span style="color: #00BFFF;">[${timestamp}]</span> ${message}`;
            
            // Add to debug box
            debugMessages.appendChild(messageElement);
            
            // Auto-scroll to bottom
            debugMessages.scrollTop = debugMessages.scrollHeight;
            
            // Show debug box if hidden
            if (debugBox.style.display === 'none') {
                debugBox.style.display = 'block';
            }
        }
        
        // Close debug box button
        document.getElementById('closeDebugBox').addEventListener('click', function() {
            document.getElementById('firebaseDebugBox').style.display = 'none';
        });

        const images = [
            'assets/images/image1.png',
            'assets/images/image2.png',
            'assets/images/image3.png',
            'assets/images/image4.png',
            'assets/images/image5.png',
            'assets/images/image6.png',
            'assets/images/image7.png',
            'assets/images/image8.png',
            'assets/images/image9.png'
        ];
        let topSequence = [];
        let bottomImages = [];
        let selection = [];
        let round = 1;
        let score = 0;
        let timeLeft = 30;
        let timerId;
        let totalRounds = 0;

        const gameDiv = document.getElementById('game');
        const topImages = [document.getElementById('top1'), document.getElementById('top2'), document.getElementById('top3')];
        const bottomImagesDiv = document.getElementById('bottomImages');
        const timerDiv = document.getElementById('timer');
        const scoreDiv = document.getElementById('score');
        const leaderboardDiv = document.getElementById('leaderboard');
        const scoreList = document.getElementById('scoreList');
        const playAgainButton = document.getElementById('playAgain');
        const rocket = document.getElementById('rocket');

        playAgainButton.addEventListener('click', startGame);
        window.onload = startGame;

        // Sound and Haptic System - 26.02.2025 start
        let soundEnabled = true;
        const soundToggle = document.getElementById('soundToggle');
        const soundIcon = document.getElementById('soundIcon');
        
        // Create audio context
        let audioContext;
        
        // Sound effects object
        const sounds = {
            select: null,
            correct: null,
            incorrect: null,
            timeLow: null,
            victory: null
        };
        
        // Initialize audio context (needs to be triggered by user interaction)
        function initAudio() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    createSounds();
                } catch (e) {
                    console.error('Web Audio API is not supported in this browser:', e);
                }
            }
        }
        
        // Create sound effects
        function createSounds() {
            // Card selection sound
            sounds.select = createOscillatorSound(600, 0.1, 'sine');
            
            // Correct match sound
            sounds.correct = createComplexSound([
                {freq: 800, duration: 0.1, type: 'sine'},
                {freq: 1000, duration: 0.1, type: 'sine', delay: 0.1},
                {freq: 1200, duration: 0.2, type: 'sine', delay: 0.2}
            ]);
            
            // Incorrect match sound
            sounds.incorrect = createComplexSound([
                {freq: 300, duration: 0.2, type: 'sine'},
                {freq: 200, duration: 0.3, type: 'sine', delay: 0.1}
            ]);
            
            // Time running low warning
            sounds.timeLow = createOscillatorSound(400, 0.15, 'sawtooth');
            
            // Victory celebration sound
            sounds.victory = createComplexSound([
                {freq: 600, duration: 0.1, type: 'sine'},
                {freq: 800, duration: 0.1, type: 'sine', delay: 0.1},
                {freq: 1000, duration: 0.1, type: 'sine', delay: 0.2},
                {freq: 1200, duration: 0.3, type: 'sine', delay: 0.3}
            ]);
        }
        
        // Create a simple oscillator sound
        function createOscillatorSound(frequency, duration, type) {
            return function() {
                if (!soundEnabled || !audioContext) return;
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.type = type;
                oscillator.frequency.value = frequency;
                
                gainNode.gain.value = 0.3;
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start();
                
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                oscillator.stop(audioContext.currentTime + duration);
            };
        }
        
        // Create a more complex sound with multiple tones
        function createComplexSound(toneConfigs) {
            return function() {
                if (!soundEnabled || !audioContext) return;
                
                toneConfigs.forEach(config => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.type = config.type;
                    oscillator.frequency.value = config.freq;
                    
                    gainNode.gain.value = 0.2;
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    const startTime = audioContext.currentTime + (config.delay || 0);
                    oscillator.start(startTime);
                    
                    gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + config.duration);
                    oscillator.stop(startTime + config.duration);
                });
            };
        }
        
        // Haptic feedback function - 26.02.2025 fix start
        function vibrate(pattern) {
            // Check if vibration is supported and device is likely mobile
            if (typeof navigator.vibrate !== 'function') {
                return false; // Silently fail on unsupported devices
            }
            
            // Only vibrate if sound is enabled and we're on mobile
            if (soundEnabled && /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                try {
                    return navigator.vibrate(pattern);
                } catch (e) {
                    console.log("Vibration failed:", e);
                    return false;
                }
            }
            return false;
        }
        // 26.02.2025 fix end
        
                    // Toggle sound - 26.02.2025 fix start
        soundToggle.addEventListener('click', function() {
            soundEnabled = !soundEnabled;
            soundIcon.src = soundEnabled ? 'assets/images/sound-on.png' : 'assets/images/sound-off.png';
            
            // Save user preference to localStorage
            localStorage.setItem('soundEnabled', soundEnabled ? 'true' : 'false');
            
            // Initialize audio on first user interaction
            if (soundEnabled && !audioContext) {
                initAudio();
            }
            
            // Give feedback when toggling
            if (soundEnabled) {
                if (sounds.select) sounds.select();
                // Test vibration with a simple pattern
                vibrate(100);
            }
        });
        
        // Load sound preference from localStorage if available
        if (localStorage.getItem('soundEnabled') === 'false') {
            soundEnabled = false;
            soundIcon.src = 'assets/images/sound-off.png';
        }
        // 26.02.2025 fix end
        // 26.02.2025 end

        function startGame() {
            round = 1;
            score = 0;
            timeLeft = 30;
            totalRounds = 0;
            selection = [];
            gameDiv.style.display = 'flex';
            leaderboardDiv.style.display = 'none';
            rocket.style.display = 'none';
            setupRound();
            startGameTimer();
            
            // Initialize audio on first game start with user interaction
            // 26.02.2025 start
            if (soundEnabled && !audioContext) {
                initAudio();
            }
            // 26.02.2025 end
        }

        function startGameTimer() {
            clearInterval(timerId);
            timerId = setInterval(() => {
                timeLeft -= 0.1;
                timerDiv.textContent = `Time: ${Math.max(timeLeft, 0).toFixed(1)}s`;
                
                // 26.02.2025 start
                // Warning sound when time is running low
                if (timeLeft <= 10 && timeLeft > 0 && Math.round(timeLeft * 10) % 10 === 0) {
                    if (sounds.timeLow) sounds.timeLow();
                    if (timeLeft <= 5) {
                        vibrate(50);
                    }
                }
                // 26.02.2025 end
                
                if (timeLeft <= 0) {
                    clearInterval(timerId);
                    endGameSequence();
                }
            }, 100);
        }

        function setupRound() {
            topSequence = [];
            while (topSequence.length < 3) {
                const idx = Math.floor(Math.random() * 9);
                if (!topSequence.includes(idx)) {
                    topSequence.push(idx);
                }
            }
            bottomImages = [...Array(9).keys()];
            shuffle(bottomImages);
            topImages.forEach((img, i) => {
                img.src = images[topSequence[i]];
                img.classList.remove('glow-effect');
            });
            bottomImagesDiv.innerHTML = '';
            bottomImages.forEach((idx) => {
                const img = document.createElement('img');
                img.src = images[idx];
                img.dataset.index = idx;
                img.addEventListener('click', () => selectImage(idx));
                if (round > 10) img.classList.add('glow-effect');
                bottomImagesDiv.appendChild(img);
            });
            selection = [];
            scoreDiv.textContent = `Score: ${score} (Round: ${round})`;
        }

        function selectImage(idx) {
            if (selection.length < 3 && !selection.includes(idx)) {
                selection.push(idx);
                const img = bottomImagesDiv.querySelector(`img[data-index="${idx}"]`);
                img.classList.add('selected');
                
                // 26.02.2025 start
                // Play selection sound and vibrate
                if (sounds.select) sounds.select();
                vibrate(30);
                // 26.02.2025 end
                
                if (selection.length === 3) {
                    checkSequence();
                }
            }
        }

        function calculatePoints(timeLeft, round) {
            return Math.floor(timeLeft * round * 2); // Example formula
        }

        function updateStatusBar() {
            const statusBar = document.getElementById('statusBar');
            statusBar.textContent = `Round: ${round} | Total Points: ${score}`;
        }

        function checkSequence() {
            if (JSON.stringify(selection) === JSON.stringify(topSequence)) {
                const pointsEarned = calculatePoints(timeLeft, round);
                score += pointsEarned;
                totalRounds++;
                round++;
                
                // 26.02.2025 start
                // Play correct match sound and vibrate with success pattern
                if (sounds.correct) sounds.correct();
                vibrate([50, 30, 50, 30, 100]);
                // 26.02.2025 end
                
                setupRound();
                updateStatusBar();
            } else {
                // 26.02.2025 start
                // Play incorrect match sound and vibrate with failure pattern
                if (sounds.incorrect) sounds.incorrect();
                vibrate([100, 50, 100]);
                // 26.02.2025 end
                
                endGameSequence();
            }
        }

        function endGameSequence() {
            clearInterval(timerId);
            document.querySelectorAll('#topImages img, #bottomImages img').forEach(img => {
                img.src = 'assets/images/image2.png';
                img.classList.remove('glow-effect');
            });
            
            const successMessage = document.createElement('div');
            successMessage.style.fontSize = '24px';
            successMessage.style.color = '#00BFFF';
            successMessage.style.textAlign = 'center';
            successMessage.style.margin = '20px 0';
            successMessage.innerHTML = `
                <p>Great job!</p>
                <p>Total Rounds: ${totalRounds}</p>
                <p>Total Score: ${score}</p>
            `;
            
            gameDiv.appendChild(successMessage);
            
            // Play victory sound
            if (sounds.victory) sounds.victory();
            vibrate([50, 30, 100, 30, 100, 30, 200]);
            
            // First notify the display about game completion
            console.log("About to notify display about game completion");
            notifyDisplayGameComplete();
            console.log("Notification sent to display");
            
            // Show success animation for 5 seconds on controller
            const urlParams = new URLSearchParams(window.location.search);
            const displayId = urlParams.get('display');
            
            // Create an iframe to show the success animation
            const successFrame = document.createElement('iframe');
            successFrame.style.position = 'fixed';
            successFrame.style.top = '0';
            successFrame.style.left = '0';
            successFrame.style.width = '100%';
            successFrame.style.height = '100%';
            successFrame.style.border = 'none';
            successFrame.style.zIndex = '1000';
            successFrame.src = `/success/success.html?display=${encodeURIComponent(displayId)}&autoclose=true`;
            document.body.appendChild(successFrame);
            
            // Wait for iframe to load before starting the timer
            successFrame.onload = function() {
                console.log("Success animation loaded, starting 5-second timer");
                setTimeout(() => {
                    console.log("Animation timer complete, removing iframe");
                    document.body.removeChild(successFrame);
                    
                    // Get username from URL parameter if available
                    const usernameFromURL = urlParams.get('username');
                    // Now ask for the player's name and save score
                    const playerName = prompt("Please enter your name:", usernameFromURL || "Player");
                    const name = playerName ? playerName : "Anonymous";
                    
                    // Get user ID from multiple possible sources
                    const userId = urlParams.get('userId') || sessionStorage.getItem('gameUserId');
                    const currentUser = firebase.auth().currentUser;
                    
                    // Determine which user ID to use for updating statistics
                    const userIdToUse = currentUser ? currentUser.uid : userId;

                    // Update user statistics in Firestore if we have a user ID
                    if (userIdToUse) {
                        logFirebaseDebug(`Updating user statistics in Firestore for user ID: ${userIdToUse}`);
                        
                        const db = firebase.firestore();
                        const userRef = db.collection("users").doc(userIdToUse);
                        
                        // First get the current user data to compare points
                        userRef.get().then((doc) => {
                            if (doc.exists) {
                                const userData = doc.data();
                                const currentPoints = userData.points || 0;
                                const currentNumberPlayed = userData['number-played'] || 0;
                                
                                // Prepare update data
                                const updateData = {
                                    'lastUpdated': firebase.firestore.FieldValue.serverTimestamp(),
                                    'number-played': currentNumberPlayed + 1,
                                    'name': name // Update name with the provided one
                                };
                                
                                // Only update points if new score is higher
                                if (score > currentPoints) {
                                    updateData.points = score;
                                    logFirebaseDebug(`New high score! Updating points to ${score}`);
                                }
                                
                                // Update user document
                                userRef.update(updateData)
                                    .then(() => {
                                        logFirebaseDebug(`User statistics updated successfully`);
                                        // Show leaderboard on controller
                                        gameDiv.style.display = 'none';
                                        leaderboardDiv.style.display = 'block';
                                        // Use the controller's leaderboard implementation
                                        setDisplayContent("SHOW_LEADERBOARD")
                                            .then(() => {
                                                showLeaderboard();
                                            })
                                            .catch(error => {
                                                console.error("Error showing leaderboard:", error);
                                                showLeaderboard(); // Show leaderboard anyway even if display notification fails
                                            });
                                    })
                                    .catch((error) => {
                                        logFirebaseDebug(`Error updating user statistics: ${error.message}`, true);
                                    });
                            } else {
                                // Document doesn't exist, create it with initial values
                                const newUserData = {
                                    'points': score,
                                    'number-played': 1,
                                    'lastUpdated': firebase.firestore.FieldValue.serverTimestamp(),
                                    'name': name
                                };
                                
                                userRef.set(newUserData)
                                    .then(() => {
                                        logFirebaseDebug(`Created new user document with statistics`);
                                        // Show leaderboard on controller
                                        gameDiv.style.display = 'none';
                                        leaderboardDiv.style.display = 'block';
                                        // Use the controller's leaderboard implementation
                                        setDisplayContent("SHOW_LEADERBOARD")
                                            .then(() => {
                                                showLeaderboard();
                                            })
                                            .catch(error => {
                                                console.error("Error showing leaderboard:", error);
                                                showLeaderboard(); // Show leaderboard anyway even if display notification fails
                                            });
                                    })
                                    .catch((error) => {
                                        logFirebaseDebug(`Error creating user document: ${error.message}`, true);
                                    });
                            }
                        }).catch((error) => {
                            logFirebaseDebug(`Error getting user document: ${error.message}`, true);
                        });
                    } else {
                        logFirebaseDebug(`No user ID found. Cannot update statistics.`, true);
                        // Even if we can't update stats, still show leaderboard
                        gameDiv.style.display = 'none';
                        leaderboardDiv.style.display = 'block';
                        showLeaderboard();
                    }
                }, 5000);
            };
        }

        function showLeaderboard() {
            const scoreList = document.getElementById('scoreList');
            scoreList.innerHTML = '<div class="loading-message">Loading leaderboard data...</div>';
            
            // Show leaderboard
            const leaderboardDiv = document.getElementById('leaderboard');
            leaderboardDiv.style.display = 'flex';
            leaderboardDiv.style.opacity = '1';
            
            // Add nutrition prompt to the DOM if it doesn't exist
            if (!document.getElementById('nutritionPrompt')) {
                const nutritionPrompt = document.createElement('div');
                nutritionPrompt.id = 'nutritionPrompt';
                nutritionPrompt.innerHTML = `
                    <img src="/leaderboard/logoshop.png" alt="Simplix Shop Logo">
                    <h2>Ready for Nutrition Discounts?</h2>
                    <button id="nutritionButton" onclick="window.open('https://simplixnutrition.de', '_blank')">
                        Click Here!
                    </button>
                `;
                document.body.appendChild(nutritionPrompt);
            }
            
            // Set timer to transition to nutrition prompt
            setTimeout(() => {
                // Fade out leaderboard
                leaderboardDiv.style.opacity = '0';
                
                setTimeout(() => {
                    // Hide leaderboard
                    leaderboardDiv.style.display = 'none';
                    
                    // Show and fade in nutrition prompt
                    const nutritionPrompt = document.getElementById('nutritionPrompt');
                    nutritionPrompt.style.display = 'flex';
                    setTimeout(() => {
                        nutritionPrompt.style.opacity = '1';
                    }, 50);
                }, 500); // Wait for fade out to complete
            }, 5000); // Show leaderboard for 5 seconds
            
            // Continue with existing leaderboard data loading
            const db = firebase.firestore();
            
            // Fetch users data ordered by points
            db.collection('users')
                .orderBy('points', 'desc')
                .limit(10)
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        showFallbackLeaderboard();
                        return;
                    }
                    
                    scoreList.innerHTML = '';
                    let rank = 1; // Initialize rank counter
                    
                    querySnapshot.forEach((doc) => {
                        const userData = doc.data();
                        
                        // Get user name with fallbacks
                        const userName = userData.name || userData.displayName || 'Anonymous';
                        
                        // Get points with fallbacks - ensure it's a number
                        const points = parseInt(userData.points || userData['total-points'] || 0, 10);
                        
                        // Get rounds played with fallbacks - ensure it's a number
                        const rounds = parseInt(userData['number-played'] || 0, 10);
                        
                        // Get loyalty tier with fallbacks
                        const loyaltyTier = userData['loyalty-tier'] || 
                                          userData.loyaltyTier || 
                                          userData['loyalty_tier'] || 
                                          (userData.loyalty ? userData.loyalty.tier : null) || 
                                          'Bronze';
                        
                        // Add entry with current rank
                        addLeaderboardEntry(rank, userName, rounds, points, loyaltyTier);
                        rank++; // Increment rank for next entry
                    });
                    
                    // If no entries were added, show fallback data
                    if (rank === 1) {
                        showFallbackLeaderboard();
                    }
                })
                .catch((error) => {
                    console.error("Error fetching leaderboard:", error);
                    showFallbackLeaderboard();
                });
        }

        function showFallbackLeaderboard() {
            scoreList.innerHTML = '';
            
            // Add sample entries with proper ranking
            [
                { name: 'SuperMario', rounds: 121, points: 1369, tier: 'Gold' },
                { name: 'Marvin', rounds: 72, points: 1348, tier: 'Bronze' },
                { name: 'Mario', rounds: 115, points: 941, tier: 'Bronze' },
                { name: 'Simplix', rounds: 4, points: 935, tier: 'Bronze' },
                { name: 'Caren', rounds: 61, points: 782, tier: 'Bronze' }
            ].forEach((entry, index) => {
                addLeaderboardEntry(
                    index + 1,
                    entry.name,
                    entry.rounds,
                    entry.points,
                    entry.tier
                );
            });
        }

        function addLeaderboardEntry(rank, name, rounds, points, tier) {
            // Ensure all numeric values are actually numbers
            rank = parseInt(rank, 10);
            rounds = parseInt(rounds, 10);
            points = parseInt(points, 10);
            
            // Create the entry div with proper class names
            const entryDiv = document.createElement('div');
            entryDiv.className = `leaderboard-entry rank-${rank <= 3 ? rank : 'other'} animated-entry`;
            entryDiv.style.animationDelay = `${(rank - 1) * 0.1}s`;
            
            // Determine trophy icon for top 3
            let trophyIcon = '';
            if (rank === 1) trophyIcon = '';
            else if (rank === 2) trophyIcon = '';
            else if (rank === 3) trophyIcon = '';
            
            // Create the entry content with proper styling
            entryDiv.innerHTML = `
                <div style="text-align: center;">
                    <div class="rank-badge">${rank}</div>
                </div>
                <div style="text-align: left; padding-left: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <span style="font-weight: bold;">${name}</span> ${trophyIcon}
                </div>
                <div style="text-align: center;">
                    ${isNaN(rounds) ? 0 : rounds}
                </div>
                <div style="text-align: center; font-weight: bold;">
                    ${isNaN(points) ? 0 : points}
                </div>
                <div style="text-align: center;">
                    ${tier}
                </div>
            `;
            
            scoreList.appendChild(entryDiv);
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // The returnToController function remains, though it won't be used without the button
        function returnToController() {
            const urlParams = new URLSearchParams(window.location.search);
            const displayId = urlParams.get('display');
            window.location.href = `/controller.html?code=${displayId || ''}`;
        }

        // Check if particles were active before navigation
        if (sessionStorage.getItem('particlesActive') === 'true') {
            // Start particles
            ParticleAnimation.start('particleCanvas');
            
            // Clean up when leaving
            window.addEventListener('beforeunload', function() {
                ParticleAnimation.stop();
                sessionStorage.removeItem('particlesActive');
            });
        }

        // Add this function to notify the display about game completion
        function notifyDisplayGameComplete() {
            const urlParams = new URLSearchParams(window.location.search);
            const displayId = urlParams.get('display');
            
            if (!displayId) {
                logFirebaseDebug("No display ID found, cannot notify about game completion", true);
                return;
            }
            
            logFirebaseDebug(`Notifying display about game completion: ${displayId}`);
            
            // Initialize Firebase if not already initialized
            if (!window.firebase || !firebase.apps || !firebase.apps.length) {
                logFirebaseDebug("Firebase not initialized, initializing now...");
                
                const firebaseConfig = {
                    apiKey: "AIzaSyClBe85KzYpdCBmidhGlJlw-1eUZG9aBg8",
                    authDomain: "simplixgymrewards.firebaseapp.com",
                    databaseURL: "https://simplixgymrewards-default-rtdb.europe-west1.firebasedatabase.app",
                    projectId: "simplixgymrewards",
                    storageBucket: "simplixgymrewards.appspot.com",
                    messagingSenderId: "821049711023",
                    appId: "1:821049711023:web:32fb1e80755cc00531f75a"
                };
                
                logFirebaseDebug(`Initializing Firebase with config: ${JSON.stringify(firebaseConfig)}`);
                
                try {
                    firebase.initializeApp(firebaseConfig);
                    logFirebaseDebug("Firebase initialized successfully");
                    
                    // Ensure Firestore is initialized
                    if (firebase.firestore && typeof firebase.firestore().settings === 'function') {
                        logFirebaseDebug("Initializing Firestore with persistence...");
                        
                        firebase.firestore().settings({
                            cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
                        });
                        
                        firebase.firestore().enablePersistence({ synchronizeTabs: true })
                            .then(() => {
                                logFirebaseDebug("Firestore persistence enabled successfully");
                            })
                            .catch(err => {
                                logFirebaseDebug(`Error enabling Firestore persistence: ${err.message}`, true);
                                logFirebaseDebug(`Error code: ${err.code || 'N/A'}`, true);
                            });
                    } else {
                        logFirebaseDebug("Firestore not available or settings method not found", true);
                    }
                } catch (error) {
                    logFirebaseDebug(`Error initializing Firebase: ${error.message}`, true);
                }
            } else {
                logFirebaseDebug("Firebase already initialized");
            }
            
            // Update display status with a timestamp to ensure it's recognized as a new update
            const database = firebase.database();
            const notificationData = {
                content: "GAME1_COMPLETE",
                lastUpdated: firebase.database.ServerValue.TIMESTAMP
            };
            
            logFirebaseDebug(`Sending notification to displays/${displayId}: ${JSON.stringify(notificationData)}`);
            
            database.ref(`displays/${displayId}`).set(notificationData)
                .then(() => {
                    logFirebaseDebug("Successfully notified display about game completion");
                })
                .catch(error => {
                    logFirebaseDebug(`Error notifying display: ${error.message}`, true);
                    logFirebaseDebug(`Error code: ${error.code || 'N/A'}`, true);
                    logFirebaseDebug(`Error details: ${JSON.stringify(error)}`, true);
                });
        }

        // Function to notify display to show leaderboard
        function notifyDisplayShowLeaderboard() {
            const urlParams = new URLSearchParams(window.location.search);
            const displayId = urlParams.get('display');
            
            if (!displayId) {
                logFirebaseDebug("No display ID found, cannot notify about leaderboard", true);
                return;
            }
            
            logFirebaseDebug(`Notifying display to show leaderboard: ${displayId}`);
            
            // Update display status with a command to show leaderboard
            const database = firebase.database();
            const notificationData = {
                content: "SHOW_LEADERBOARD",
                lastUpdated: firebase.database.ServerValue.TIMESTAMP
            };
            
            logFirebaseDebug(`Sending notification to displays/${displayId}: ${JSON.stringify(notificationData)}`);
            
            database.ref(`displays/${displayId}`).set(notificationData)
                .then(() => {
                    logFirebaseDebug("Successfully notified display to show leaderboard");
                })
                .catch(error => {
                    logFirebaseDebug(`Error notifying display: ${error.message}`, true);
                });
        }

        // Function to send display content
        function setDisplayContent(content) {
            const urlParams = new URLSearchParams(window.location.search);
            const displayId = urlParams.get('display');
            
            if (!displayId) {
                return Promise.reject(new Error("No display ID found"));
            }
            
            return firebase.database().ref(`displays/${displayId}`).set({
                content: content,
                lastUpdated: firebase.database.ServerValue.TIMESTAMP
            });
        }
    </script>
</body>
</html>